<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Update Mechanism</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .card {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      h1 {
        color: #667eea;
      }
      button {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin-right: 10px;
      }
      button:hover {
        background: #764ba2;
      }
      .version {
        display: inline-block;
        background: #4caf50;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
      }
      pre {
        background: #f0f0f0;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>üöÄ PWA Update Test Page</h1>
      <p>Current Version: <span class="version">8.0.0</span></p>
      <p>This page helps you test the update mechanism.</p>
    </div>

    <div class="card">
      <h2>üìù How to Test Updates</h2>
      <ol>
        <li>
          <strong>Make a change:</strong> Edit this HTML file (change version
          number above)
        </li>
        <li>
          <strong>Update cache version:</strong> In <code>sw.js</code>, change:
          <pre>const CACHE_NAME = 'my-pwa-v1'; // to v2, v3, etc.</pre>
        </li>
        <li><strong>Reload:</strong> Refresh the page</li>
        <li>
          <strong>Wait for banner:</strong> You should see an update
          notification appear
        </li>
        <li>
          <strong>Click "Update Now":</strong> Page reloads with new content
        </li>
      </ol>
    </div>

    <div class="card">
      <h2>üîß Manual Controls</h2>
      <button onclick="checkForUpdates()">Check for Updates</button>
      <button onclick="showSwStatus()">Show SW Status</button>
      <button onclick="clearEverything()">Clear All & Reload</button>
      <div id="status" style="margin-top: 15px; color: #666"></div>
    </div>

    <div class="card">
      <h2>üìä Current Status</h2>
      <div id="info">Loading...</div>
    </div>

    <script>
      const status = document.getElementById('status');
      const info = document.getElementById('info');

      // Show initial info
      async function showInfo() {
        let html = '';

        if ('serviceWorker' in navigator) {
          const reg = await navigator.serviceWorker.getRegistration();
          if (reg) {
            html += '<p>‚úÖ Service Worker: <strong>Registered</strong></p>';
            html += `<p>Scope: <code>${reg.scope}</code></p>`;
            if (reg.active) html += '<p>State: <strong>Active</strong></p>';
            if (reg.waiting)
              html += '<p>‚ö†Ô∏è Update: <strong>Waiting to activate</strong></p>';
            if (reg.installing)
              html += '<p>‚¨áÔ∏è Update: <strong>Installing</strong></p>';
          } else {
            html += '<p>‚ùå Service Worker: <strong>Not registered</strong></p>';
          }
        } else {
          html += '<p>‚ùå Service Workers not supported</p>';
        }

        const cacheKeys = await caches.keys();
        html += `<p>Cache versions: <strong>${
          cacheKeys.join(', ') || 'None'
        }</strong></p>`;

        info.innerHTML = html;
      }

      showInfo();
      setInterval(showInfo, 5000); // Refresh every 5 seconds

      // Manual update check
      async function checkForUpdates() {
        if ('serviceWorker' in navigator) {
          const reg = await navigator.serviceWorker.getRegistration();
          if (reg) {
            status.textContent = 'Checking for updates...';
            await reg.update();
            status.textContent = '‚úÖ Update check complete!';
            setTimeout(() => (status.textContent = ''), 3000);
          } else {
            status.textContent = '‚ùå No service worker registered';
          }
        }
      }

      // Show SW status
      async function showSwStatus() {
        if ('serviceWorker' in navigator) {
          const reg = await navigator.serviceWorker.getRegistration();
          if (reg) {
            status.innerHTML = `
                        Active: ${reg.active ? '‚úÖ' : '‚ùå'}<br>
                        Waiting: ${
                          reg.waiting ? '‚ö†Ô∏è YES - Update available!' : '‚úÖ No'
                        }<br>
                        Installing: ${reg.installing ? '‚¨áÔ∏è YES' : '‚úÖ No'}
                    `;
          }
        }
      }

      // Clear everything
      async function clearEverything() {
        if (
          confirm(
            'This will unregister service worker and clear all caches. Continue?'
          )
        ) {
          // Unregister service workers
          const registrations =
            await navigator.serviceWorker.getRegistrations();
          for (const reg of registrations) {
            await reg.unregister();
          }

          // Clear caches
          const cacheKeys = await caches.keys();
          for (const key of cacheKeys) {
            await caches.delete(key);
          }

          status.textContent = 'üóëÔ∏è Cleared! Reloading...';
          setTimeout(() => location.reload(), 1000);
        }
      }
    </script>
  </body>
</html>
